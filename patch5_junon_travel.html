<!-- PATCH 5 — Junon Polis + Boat Travel (Plains ⇄ Junon) -->
<!-- FIND: function nearest(obj) { -->
<!-- INSERT AFTER: -->
<script>
// ==== PATCH 5: Multi-map + ferry travel ====
let mapName = 'plains';
let transition = {a:0,to:null};

const harbor  = {kind:'npc', npc:'harbor', x: TILE*12.0, y: TILE*9.6,  r:26};  // plains dock
const ferryJ  = {kind:'npc', npc:'ferryJ', x: TILE*44.0, y: TILE*58.0, r:26};  // junon dock
let ferryCost = 60;

const MAPS = {
  plains: { label:'Adventure Plains', gen: genPlains,  spawn:{main:{x: TILE*4, y: TILE*6}} },
  junon:  { label:'Junon Polis',      gen: genJunon,   spawn:{dock:{x: TILE*44, y: TILE*58}, gate:{x:TILE*20, y:TILE*28}} }
};

function saveMeta(){ try{ localStorage.setItem('ap-meta', JSON.stringify({mapName})); }catch(e){} }
function loadMeta(){ try{ const m=JSON.parse(localStorage.getItem('ap-meta')||'{}'); if(m.mapName) mapName=m.mapName; }catch(e){} }

function drawTransitionOverlay(){
  if(!transition.to && transition.a<=0) return;
  if(transition.to){ transition.a += 0.06; if(transition.a>=1){
      const {next, spawnTag} = transition.to;
      mapName = next; softResetRuntime(); MAPS[mapName].gen();
      const sp = MAPS[mapName].spawn[spawnTag] || Object.values(MAPS[mapName].spawn)[0];
      player.x = sp.x; player.y = sp.y; saveMeta(); transition.to=null;
    }
  } else { transition.a -= 0.06; if(transition.a<0) transition.a=0; }
  ctx.save(); ctx.globalAlpha = Math.min(1,Math.max(0,transition.a)); ctx.fillStyle='#000'; ctx.fillRect(0,0,vw,vh); ctx.restore();
}
function changeMap(next, spawnTag='main'){ transition.to={next, spawnTag}; }

function softResetRuntime(){ ents.length=0; projs.length=0; drops.length=0; decor.length=0; turrets.length=0; }

function interactHarbor(){
  if(mapName==='plains'){
    if((player.gold|0) < ferryCost){ notify(`Boat fare is ${ferryCost}✦`); return; }
    player.gold -= ferryCost; notify('Setting sail for Junon Polis…'); changeMap('junon','dock'); save();
  } else {
    const back = Math.floor(ferryCost*0.5);
    if((player.gold|0) < back){ notify(`Return fare is ${back}✦`); return; }
    player.gold -= back; notify('Returning to Adventure Plains…'); changeMap('plains','main'); save();
  }
}

function drawBoatNPC(obj){
  const s=worldToScreen(obj.x,obj.y);
  ctx.fillStyle='#3a2c12'; ctx.fillRect(s.x-26, s.y-6, 52, 12);
  ctx.fillStyle='#2b4a6a'; ctx.fillRect(s.x-34, s.y+6, 68, 10);
  ctx.fillStyle='#734c2a'; ctx.beginPath(); ctx.moveTo(s.x-20, s.y+6); ctx.lineTo(s.x+20, s.y+6); ctx.lineTo(s.x+12, s.y+20); ctx.lineTo(s.x-12, s.y+20); ctx.closePath(); ctx.fill();
  ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(s.x-20, s.y-42, 40, 16);
  ctx.fillStyle='#cfe'; ctx.fillText('⛵ E', s.x-14, s.y-30);
}

// === Plains regeneration (keeps your current layout, just rebuilds decor) ===
function genPlains(){
  for(let i=0;i<MAP_W*MAP_H;i++){
    let x=i%MAP_W, y=(i/MAP_W)|0;
    let g = (Math.sin(x*0.33)+Math.cos(y*0.27))*0.5 + Math.random()*0.6;
    tiles[i] = g>0.55?1:0;
  }
  for(let y=20;y<28;y++) for(let x=20;x<28;x++){ if((x-24)**2+(y-24)**2<16) tiles[y*MAP_W+x]=2; }
  decor.length=0;
  for(let y=0;y<MAP_H;y++){ for(let x=0;x<MAP_W;x++){
    if(tiles[y*MAP_W+x]===0 && Math.random()>0.965) decor.push({t: Math.random()>0.6? 'tree':'rock', x:x*TILE+8+Math.random()*(TILE-16), y:y*TILE+8+Math.random()*(TILE-16)});
    if(tiles[y*MAP_W+x]===0 && Math.random()>0.985) decor.push({t:'flower', x:x*TILE+10+Math.random()*(TILE-20), y:y*TILE+10+Math.random()*(TILE-20)});
  }}
  sign.x = TILE*6.5; sign.y = TILE*4.8; merchant.x = TILE*9.5; merchant.y = TILE*5.7; trainer.x = TILE*7.5; trainer.y = TILE*5.8; cartMaster.x = TILE*5.0; cartMaster.y = TILE*7.6;
  el('zone').textContent = MAPS.plains.label;
}

// === Junon Polis ===
function genJunon(){
  for(let i=0;i<MAP_W*MAP_H;i++) tiles[i]=0;
  const cx=18, cy=22, cw=36, ch=26;
  for(let y=cy; y<cy+ch; y++) for(let x=cx; x<cx+cw; x++) tiles[y*MAP_W+x] = 1; // dirt pad
  // canals
  for(let y=cy-2; y<cy; y++) for(let x=cx-2; x<cx+cw+2; x++) tiles[y*MAP_W+x]=2;
  for(let y=cy+ch; y<cy+ch+2; y++) for(let x=cx-2; x<cx+cw+2; x++) tiles[y*MAP_W+x]=2;
  for(let y=cy-2; y<cy+ch+2; y++) for(let x=cx-2; x<cx; x++) tiles[y*MAP_W+x]=2;
  for(let y=cy-2; y<cy+ch+2; y++) for(let x=cx+cw; x<cx+cw+2; x++) tiles[y*MAP_W+x]=2;

  // simple buildings (decor rectangles)
  const bld = (bx,by,bw,bh)=> decor.push({t:'bld', x:(bx+0.5)*TILE, y:(by+0.5)*TILE, w:bw*TILE, h:bh*TILE});
  bld(cx+2, cy+3, 8, 6); bld(cx+15, cy+3, 8, 6); bld(cx+28, cy+3, 6, 6);
  bld(cx+3, cy+16, 10, 7); bld(cx+19, cy+16, 8, 7); bld(cx+29, cy+16, 8, 7);

  // NPCs re-placed
  ferryJ.x = (cx+cw+1)*TILE; ferryJ.y = (cy+ch+1)*TILE;
  merchant.x = (cx+Math.floor(cw/2))*TILE; merchant.y = (cy+12)*TILE;
  trainer.x = (cx+Math.floor(cw/2)-2)*TILE; trainer.y = (cy+10)*TILE;
  sign.x = (cx+Math.floor(cw/2))*TILE; sign.y = (cy+9)*TILE;

  // mobs will be added by Patch 7 (moldies etc.)
  el('zone').textContent = MAPS.junon.label;
}
</script>

<!-- FIND: else if(nearest(cartMaster)<TILE*1.8){ interactCartMaster(); keys['e']=false; } -->
<!-- INSERT AFTER: -->
<script>
else if(nearest(harbor)<TILE*1.8){ interactHarbor(); keys['e']=false; }
else if(mapName==='junon' && nearest(ferryJ)<TILE*1.8){ interactHarbor(); keys['e']=false; }
</script>

<!-- FIND: // NPCs (drawing in draw()) line where drawSign/drawMerchant are called -->
<!-- INSERT AFTER (keep it near the end of draw(), before FX): -->
<script>
if(mapName==='plains') drawBoatNPC(harbor);
if(mapName==='junon')  drawBoatNPC(ferryJ);
// Fade overlay
drawTransitionOverlay();
// Junon buildings (simple)
(function drawBuildings(){
  for(const d of decor){ if(d.t!=='bld') continue; const s=worldToScreen(d.x,d.y);
    ctx.fillStyle='#243240'; ctx.fillRect(s.x - d.w/2, s.y - d.h/2, d.w, d.h);
    ctx.fillStyle='#31465a'; ctx.fillRect(s.x - d.w/2, s.y - d.h/2, d.w, 18);
    ctx.fillStyle='rgba(255,255,255,0.15)';
    for(let i=0;i<4;i++){ ctx.fillRect(s.x - d.w/2 + 12 + i*22, s.y - d.h/2 + 28, 14, 12); }
  }
})();
</script>

<!-- FIND: function save(){ -->
<!-- INSERT AFTER FIRST BRACE: -->
<script>saveMeta();</script>

<!-- FIND: function load(){ -->
<!-- INSERT AFTER FIRST BRACE: -->
<script>loadMeta();</script>

<!-- FIND (in load success path): recalcStats(); setSkillsForJob(player.job||'Visitor'); -->
<!-- INSERT AFTER: -->
<script>
if(mapName==='junon'){ genJunon(); } else { genPlains(); }
</script>

<!-- FIND: function startNew(){ -->
<!-- INSERT BEFORE the final 'save();' in startNew(): -->
<script>
mapName='plains'; genPlains(); saveMeta();
</script>
